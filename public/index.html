<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flora AI - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. CORE STYLES --- */
        :root {
            --bg-dark: #0f0f11;
            --bg-sidebar: rgba(20, 20, 23, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary-grad: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            --text-main: #ffffff;
            --accent-vision: #4AA9FF;
            --accent-edit: #FF9A9E;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html {
            margin: 0; padding: 0;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-main);
            width: 100%; height: 100dvh;
            overflow: hidden; display: flex;
        }

        .aura-bg {
            position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(255, 75, 75, 0.06), transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(100, 100, 255, 0.05), transparent 40%);
            z-index: -1; animation: spinAura 25s linear infinite; pointer-events: none;
        }
        @keyframes spinAura { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- 2. LAYOUT --- */
        #app-interface { display: none; width: 100%; height: 100%; opacity: 0; transition: opacity 0.5s; }
        
        .sidebar {
            width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; padding: 25px; gap: 20px; flex-shrink: 0;
        }

        .main-view { 
            flex: 1; display: flex; flex-direction: column; 
            position: relative; width: 100%; max-width: 100%; overflow: hidden; 
        }
        
        .mobile-top {
            display: none; padding: 15px; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--glass-border); background: rgba(15, 15, 17, 0.95); backdrop-filter: blur(10px);
            z-index: 10; width: 100%; flex-shrink: 0;
        }

        #chat-stream { 
            flex: 1; overflow-y: auto; padding: 20px 5%; 
            display: flex; flex-direction: column; width: 100%; scroll-behavior: smooth;
        }

        /* --- 3. WELCOME SCREEN --- */
        #welcome-screen {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            width: 100%; text-align: center; padding: 20px;
        }
        .greet-title { 
            font-size: 32px; font-weight: 700; margin-bottom: 10px; 
            background: linear-gradient(to right, #fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .chip-scroll-container {
            display: flex; gap: 10px; overflow-x: auto; width: 100%; padding: 5px; 
            scrollbar-width: none; justify-content: flex-start;
        }
        .chip-scroll-container::-webkit-scrollbar { display: none; }
        @media (min-width: 769px) { .chip-scroll-container { justify-content: center; } }

        .bubble-chip {
            background: rgba(255, 255, 255, 0.08); border: 1px solid var(--glass-border);
            padding: 10px 18px; border-radius: 50px; white-space: nowrap; cursor: pointer;
            font-size: 13px; font-weight: 500; color: #ddd; flex-shrink: 0;
        }

        /* --- 4. INPUT AREA --- */
        .input-dock { 
            padding: 15px; background: linear-gradient(to top, var(--bg-dark) 40%, transparent); 
            display: flex; flex-direction: column; align-items: center; 
            width: 100%; z-index: 50; flex-shrink: 0;
        }

        #preview-container { 
            display: none; width: 100%; max-width: 750px; 
            background: rgba(30, 30, 35, 0.95); 
            border: 1px solid var(--glass-border); border-radius: 16px; 
            padding: 12px; margin-bottom: 10px; 
        }

        .glass-input-bar {
            width: 100%; max-width: 750px; background: rgba(30,30,35,0.95);
            border: 1px solid var(--glass-border); border-radius: 24px; 
            padding: 8px 12px; display: flex; align-items: flex-end; gap: 10px;
        }
        textarea { flex: 1; background: transparent; border: none; color: white; font-size: 15px; resize: none; max-height: 100px; padding: 10px 0; }
        
        .icon-btn { width: 35px; height: 35px; border-radius: 50%; border:none; background:transparent; color:#aaa; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center; transition:0.2s; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .icon-btn.recording { color: #FF5E62; animation: pulse 1s infinite; }
        
        .send-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: white; color: black; cursor: pointer; flex-shrink: 0; display:flex; align-items:center; justify-content:center;}

        /* --- 5. CHAT STYLES (MODIFIED FOR NO BUBBLE BOT) --- */
        .msg-group { display: flex; gap: 15px; margin-bottom: 25px; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; }
        
        /* USER STYLE - Tetap Bubble */
        .msg-group.user { justify-content: flex-end; }
        .user .bubble { 
            background: #2a2a2e; color: #fff; 
            padding: 12px 18px; border-radius: 20px; border-bottom-right-radius: 4px;
            font-size: 15px; line-height: 1.5; max-width: 85%; word-wrap: break-word; 
        }

        /* BOT STYLE - RAW TEXT (No Bubble) */
        .msg-group.bot { justify-content: flex-start; align-items: flex-start; }
        
        .bot-content {
            flex: 1;
            font-size: 16px; /* Lebih besar dikit biar enak baca */
            line-height: 1.7;
            color: #ececf1;
            padding-top: 5px; /* Biar sejajar sama avatar */
        }

        /* Avatar Bot */
        .avatar-bot { 
            width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; 
            background: linear-gradient(135deg, #FF9A9E, #A18CD1); 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 12px; color: #000; 
            box-shadow: 0 0 10px rgba(255, 154, 158, 0.3);
        }

        .chat-img { width: 100%; max-width: 300px; border-radius: 12px; margin-top: 10px; display: block; border: 1px solid #333; }

        /* Code Block */
        pre { background: #1a1a1c; padding: 15px; border-radius: 10px; overflow-x: auto; margin: 15px 0; border: 1px solid #333; position: relative; }
        code { font-family: 'Consolas', monospace; font-size: 14px; color: #a5d6ff; }
        .copy-btn { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(255,255,255,0.1); color: #ccc; 
            border: none; border-radius: 4px; padding: 4px 8px; 
            font-size: 11px; cursor: pointer; 
        }

        /* Style Chips */
        .style-scroll { display: flex; gap: 8px; overflow-x: auto; padding-top: 10px; scrollbar-width: none; }
        .style-chip { padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 11px; white-space: nowrap; cursor: pointer; color: #ccc; transition: 0.2s;}
        
        .style-chip.active { background: var(--accent-edit); color: black; font-weight: bold; }
        .style-chip.vision-mode { border: 1px solid var(--accent-vision); color: var(--accent-vision); background: rgba(74, 169, 255, 0.1); }
        .style-chip.vision-mode.active { background: var(--accent-vision); color: white; }

        /* AUTH SCREEN */
        #auth-layer { position: fixed; inset: 0; z-index: 9999; background: rgba(15, 15, 17, 0.98); display: flex; justify-content: center; align-items: center; }
        .glass-card { width: 85%; max-width: 350px; text-align: center; padding: 30px; border-radius: 24px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); }
        .custom-input { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 14px; border-radius: 12px; color: white; margin: 20px 0; font-size: 16px; }
        .btn-glow { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--primary-grad); color: #4a1e20; font-weight: 700; cursor: pointer; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @media (min-width: 769px) { .greet-title { font-size: 42px; } }
        @media (max-width: 768px) { .sidebar { display: none; } .mobile-top { display: flex; } .main-view { width: 100vw; } }
    </style>
</head>
<body>

    <div class="aura-bg"></div>

    <div id="auth-layer">
        <div class="glass-card">
            <h1>üå∏ Flora AI</h1>
            <input type="text" id="username" class="custom-input" placeholder="Nama kamu?" autocomplete="off">
            <button class="btn-glow" onclick="handleLogin()">Mulai Chat</button>
        </div>
    </div>

    <div id="app-interface">
        
        <div class="sidebar">
            <h2 style="margin:0;">üå∏ Flora AI</h2>
            <div style="font-size:12px; color:#888;">MODEL</div>
            <select id="model-desk" style="background:#222; color:white; border:none; padding:10px; border-radius:8px; width:100%;" onchange="syncModel(this.value)">
                <option value="gemini">‚ö° Gemini Pro</option>
                <option value="gpt4">üß† GPT-4 Turbo</option>
                <option value="claude">üåø Claude 3</option>
            </select>
            <div style="margin-top:auto;">
                <button onclick="clearChat()" style="width:100%; padding:10px; background:#2A1A1A; color:#FF5E62; border:1px solid #FF5E62; border-radius:8px; cursor:pointer;">
                    <i class="fa-solid fa-trash"></i> Hapus Chat
                </button>
            </div>
        </div>

        <div class="main-view">
            <div class="mobile-top">
                <span style="font-weight:700;">Flora AI</span>
                <div style="display:flex; gap:10px;">
                    <button onclick="clearChat()" style="background:none; border:none; color:#FF5E62; font-size:16px;"><i class="fa-solid fa-trash"></i></button>
                    <select id="model-mob" style="background:#222; color:white; border:none; padding:6px 10px; border-radius:8px; font-size:12px;" onchange="syncModel(this.value)">
                        <option value="gemini">‚ö° Gemini</option>
                        <option value="gpt4">üß† GPT-4</option>
                        <option value="claude">üåø Claude</option>
                    </select>
                </div>
            </div>

            <div id="chat-stream">
                <div id="welcome-screen">
                    <div class="greet-title">Halo, <span id="u-name" style="color:#FF9A9E;">User</span></div>
                    <p style="color:#8b8b93; font-size:14px; margin-bottom:20px;">Flora siap membantu (Teks & Vision).</p>
                    
                    <div class="chip-scroll-container">
                        <div class="bubble-chip" onclick="setInput('Buatkan caption IG')"><i class="fa-brands fa-instagram"></i> Caption</div>
                        <div class="bubble-chip" onclick="setInput('Apa itu Vision AI?')"><i class="fa-solid fa-eye"></i> Tanya AI</div>
                        <div class="bubble-chip" onclick="setInput('Edit gambar ini')"><i class="fa-solid fa-wand-magic-sparkles"></i> Edit</div>
                        <div class="bubble-chip" onclick="setInput('Jelaskan Python')"><i class="fa-brands fa-python"></i> Koding</div>
                    </div>
                </div>
                <div id="msg-container"></div>
            </div>

            <div class="input-dock">
                <div id="preview-container">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <img id="img-thumb" style="width:50px; height:50px; object-fit:cover; border-radius:8px; border:1px solid #555;">
                        <div style="flex:1;">
                            <div id="mode-label" style="font-size:12px; color:white; font-weight:bold;">Vision Mode</div>
                            <div style="font-size:11px; color:#888;">Tanya gambar atau pilih gaya edit:</div>
                        </div>
                        <button onclick="clearImage()" style="background:none; border:none; color:#FF5E62; padding:10px;">‚úï</button>
                    </div>
                    
                    <div class="style-scroll">
                        <div class="style-chip vision-mode active" onclick="setVisionMode(this)">üëÅÔ∏è Tanya Gambar</div>
                        <div class="style-chip" onclick="setStyle(this, 'Anime')">Anime</div>
                        <div class="style-chip" onclick="setStyle(this, 'Cyberpunk')">Cyberpunk</div>
                        <div class="style-chip" onclick="setStyle(this, 'Realistic')">Realistic</div>
                        <div class="style-chip" onclick="setStyle(this, 'Ghibli')">Ghibli</div>
                        <div class="style-chip" onclick="setStyle(this, '3D Render')">3D Render</div>
                    </div>
                </div>

                <div class="glass-input-bar">
                    <button class="icon-btn" onclick="document.getElementById('file-input').click()">
                        <i class="fa-solid fa-image"></i>
                    </button>
                    <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="handleFile(this)">
                    
                    <textarea id="user-input" rows="1" placeholder="Ketik pesan..." oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'"></textarea>
                    
                    <button id="mic-btn" class="icon-btn" onclick="toggleVoice()">
                        <i class="fa-solid fa-microphone"></i>
                    </button>

                    <button class="send-btn" onclick="sendMessage()"><i class="fa-solid fa-arrow-up"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentImg64 = null;
        let selectedStyle = ""; // KOSONG = VISION, ISI = EDIT
        let chatHistory = [];
        let currentModel = 'gemini';
        let recognition = null;

        // --- LOGIN & INIT ---
        function handleLogin() {
            try {
                const name = document.getElementById('username').value.trim() || "User";
                localStorage.setItem('flora_username', name);
                initApp(name);
            } catch (e) { initApp("User"); }
        }

        function initApp(name) {
            document.getElementById('u-name').innerText = name;
            const auth = document.getElementById('auth-layer');
            const app = document.getElementById('app-interface');
            auth.style.opacity = 0;
            setTimeout(() => {
                auth.style.display = 'none';
                app.style.display = 'flex';
                setTimeout(() => app.style.opacity = 1, 50);
                loadChat();
            }, 300);
        }

        window.onload = () => {
            const savedName = localStorage.getItem('flora_username');
            if(savedName) { 
                document.getElementById('username').value = savedName;
                initApp(savedName);
            }
        };

        // --- LOCAL STORAGE ---
        function saveChat() {
            localStorage.setItem('flora_history', JSON.stringify(chatHistory));
            localStorage.setItem('flora_html', document.getElementById('msg-container').innerHTML);
        }
        function loadChat() {
            const savedHist = localStorage.getItem('flora_history');
            const savedHTML = localStorage.getItem('flora_html');
            if (savedHist && savedHTML) {
                chatHistory = JSON.parse(savedHist);
                document.getElementById('msg-container').innerHTML = savedHTML;
                document.getElementById('welcome-screen').style.display = 'none';
                scrollToBottom();
            }
        }
        function clearChat() {
            if(confirm("Hapus semua chat?")) {
                localStorage.removeItem('flora_history');
                localStorage.removeItem('flora_html');
                location.reload();
            }
        }

        // --- VOICE ---
        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window)) { alert("Fitur suara tidak didukung browser ini."); return; }
            const btn = document.getElementById('mic-btn');
            if (recognition) { recognition.stop(); recognition = null; btn.classList.remove('recording'); return; }
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.onstart = () => btn.classList.add('recording');
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('user-input');
                input.value += (input.value ? " " : "") + transcript;
                input.style.height = 'auto'; 
                input.style.height = input.scrollHeight + 'px';
            };
            recognition.onend = () => { recognition = null; btn.classList.remove('recording'); };
            recognition.start();
        }

        // --- IMAGE LOGIC ---
        function handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImg64 = e.target.result;
                    document.getElementById('img-thumb').src = currentImg64;
                    document.getElementById('preview-container').style.display = 'block';
                    setVisionMode(document.querySelector('.vision-mode')); // Default Vision
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearImage() {
            currentImg64 = null;
            selectedStyle = "";
            document.getElementById('file-input').value = "";
            document.getElementById('preview-container').style.display = 'none';
        }

        function setVisionMode(el) {
            document.querySelectorAll('.style-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedStyle = ""; // PENTING: Jika style kosong, logika akan masuk ke /api (index.js)
            document.getElementById('mode-label').innerText = "Vision Mode (Tanya Gambar)";
            document.getElementById('mode-label').style.color = "#4AA9FF";
        }

        function setStyle(el, styleName) {
            document.querySelectorAll('.style-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            selectedStyle = styleName; // PENTING: Jika ada style, logika akan masuk ke /api/edit
            document.getElementById('mode-label').innerText = "Edit Mode: " + styleName;
            document.getElementById('mode-label').style.color = "#FF9A9E";
        }

        // --- SEND LOGIC ---
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const txt = input.value.trim();

            if (!txt && !currentImg64) return;

            document.getElementById('welcome-screen').style.display = 'none';

            // --- LOGIKA ROUTING ---
            // KASUS 1: EDIT GAMBAR (Harus ada Gambar DAN Style dipilih)
            if (currentImg64 && selectedStyle) {
                const promptFinal = `${selectedStyle} style, ${txt}`;
                addBubble(`Edit: <b>${promptFinal}</b>`, 'user', currentImg64);
                
                const imgData = currentImg64;
                clearImage();
                input.value = "";
                
                const loadId = addBubble("Sedang memproses antrian...", 'bot', null, true);

                try {
                    const resStart = await fetch('/api/edit', { // REQUEST KE API EDIT
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ step: 'start', image: imgData, prompt: promptFinal })
                    });
                    const dataStart = await resStart.json();
                    if (!dataStart.success) throw new Error("Gagal memulai job.");

                    const jobId = dataStart.jobId;
                    const interval = setInterval(async () => {
                        try {
                            const resCheck = await fetch('/api/edit', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ step: 'check', jobId: jobId })
                            });
                            const dataCheck = await resCheck.json();
                            
                            if (dataCheck.status === 'done') {
                                clearInterval(interval);
                                document.getElementById(loadId).remove();
                                addBubble("Selesai! Ini hasilnya:", 'bot');
                                addResultImage(dataCheck.url);
                                saveChat();
                            } else if (dataCheck.status === 'failed') {
                                clearInterval(interval);
                                document.getElementById(loadId).querySelector('.bot-content').innerHTML = "Gagal: " + dataCheck.error;
                            }
                        } catch (e) { clearInterval(interval); }
                    }, 3000);
                } catch (e) {
                    document.getElementById(loadId).querySelector('.bot-content').innerHTML = "Error: " + e.message;
                }

            } else {
                // KASUS 2: TEXT BIASA atau VISION (Tanya Gambar)
                // Jika gambar ada tapi style kosong (setVisionMode), masuk ke sini (API Index)
                
                addBubble(txt, 'user', currentImg64);
                chatHistory.push({ role: "user", content: txt });
                
                const imgPayload = currentImg64; // Bawa gambar jika ada
                clearImage();
                input.value = "";
                
                const loadId = addBubble("...", 'bot', null, true);
                
                try {
                    const res = await fetch('/api', { // REQUEST KE API UTAMA/INDEX
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            history: chatHistory, 
                            message: txt,
                            image: imgPayload 
                        })
                    });
                    const data = await res.json();
                    
                    document.getElementById(loadId).remove();
                    addBubble(data.reply, 'bot');
                    chatHistory.push({ role: "assistant", content: data.reply });
                    saveChat();

                } catch (e) {
                    document.getElementById(loadId).querySelector('.bot-content').innerHTML = "Error: " + e.message;
                }
            }
        }

        // --- UI HELPERS ---
        function syncModel(val) {
            currentModel = val;
            document.getElementById('model-desk').value = val;
            document.getElementById('model-mob').value = val;
        }

        function setInput(txt) {
            document.getElementById('user-input').value = txt;
            sendMessage();
        }

        function addBubble(html, role, img = null, isLoading = false) {
            const container = document.getElementById('msg-container');
            const div = document.createElement('div');
            div.className = `msg-group ${role}`;
            if (isLoading) div.id = 'loading-' + Date.now();

            let contentHTML = '';
            
            // USER: Tetap pakai Bubble Box
            if (role === 'user') {
                contentHTML = `
                    <div class="bubble">
                        ${img ? `<img src="${img}" style="width:100px; border-radius:8px; display:block; margin-bottom:5px; border:1px solid #555;">` : ''}
                        ${html}
                    </div>
                `;
            } else {
                // BOT: TANPA BUBBLE BOX (RAW TEXT STYLE)
                let formatted = isLoading ? '<i class="fa-solid fa-circle-notch fa-spin" style="color:#FF9A9E"></i>' : html.replace(/\n/g, '<br>');
                if(!isLoading) {
                    formatted = formatted.replace(/```([\s\S]*?)```/g, function(match, code) {
                        return `<pre><code>${code}</code><button class="copy-btn" onclick="copyCode(this)">Copy</button></pre>`;
                    });
                    formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<b style="color:#fff;">$1</b>'); // Bold lebih terang
                }
                contentHTML = `
                    <div class="avatar-bot">AI</div>
                    <div class="bot-content">${formatted}</div>
                `;
            }
            div.innerHTML = contentHTML;
            container.appendChild(div);
            scrollToBottom();
            return div.id;
        }

        function addResultImage(url) {
            const container = document.getElementById('msg-container');
            const div = document.createElement('div');
            div.className = 'msg-group bot';
            div.innerHTML = `
                <div class="avatar-bot">AI</div>
                <div class="bot-content">
                    <img src="${url}" class="chat-img">
                    <div style="margin-top:5px; font-size:11px; color:#aaa;">Tekan lama untuk simpan</div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const stream = document.getElementById('chat-stream');
            stream.scrollTop = stream.scrollHeight;
        }

        function copyCode(btn) {
            const code = btn.previousElementSibling.innerText;
            navigator.clipboard.writeText(code);
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = "Copy", 2000);
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
    </script>
</body>
</html>
