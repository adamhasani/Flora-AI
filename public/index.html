<!DOCTYPE html>
<html lang="id">
<head>
    <title>Flora AI | Premium</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;800&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { 
            --primary: #007AFF; 
            --bg: #F8F9FB; 
            --text: #1C1C1E; 
            --sub: #8E8E93; 
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); overflow: hidden; 
        }

        /* --- AUTH SCREEN --- */
        #auth-screen { position: fixed; inset: 0; background: #FFF; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 30px; transition: 0.8s; }
        .auth-card { width: 100%; max-width: 340px; text-align: center; }
        .input-auth { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid #E5E5EA; background: #F2F2F7; outline: none; margin-bottom: 12px; font-size: 15px; }
        .btn-auth { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--text); color: #FFF; font-weight: 700; cursor: pointer; }

        /* --- MAIN APP --- */
        #main-app { display: none; height: 100%; flex-direction: column; }
        
        .header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); padding: 15px 25px; border-bottom: 1px solid #EEE; position: relative; z-index: 100; }
        .aura-header { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); width: 120%; height: 100px; filter: blur(40px); background: radial-gradient(circle, #007AFF, #AF52DE, transparent); opacity: 0.25; pointer-events: none; }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

        /* BUBBLE USER */
        .msg.user { 
            align-self: flex-end; background: var(--primary); color: #FFF; 
            padding: 12px 18px; border-radius: 20px 20px 4px 20px; 
            max-width: 80%; font-size: 14.5px; box-shadow: 0 4px 12px rgba(0,122,255,0.2);
        }

        /* BUBBLE BOT (BORDERLESS BUT ELEGANT) */
        .msg.bot { align-self: flex-start; max-width: 90%; }
        .bot-label { font-size: 9px; font-weight: 800; color: var(--primary); letter-spacing: 1.5px; margin-bottom: 6px; display: block; opacity: 0.8; }
        .bot-content { font-size: 15.5px; line-height: 1.7; color: var(--text); }

        /* IMAGE PROMPT AREA (FIXED) */
        #draft-area { display: none; padding: 10px 20px; }
        .prompt-card { 
            background: #FFF; border-radius: 18px; padding: 10px; 
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #EEE;
        }
        .img-preview { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; }
        
        /* INPUT AREA (MODERN & NO PENYOK) */
        .input-wrapper { padding: 10px 20px 30px; background: transparent; }
        .glass-container { 
            background: #FFF; border-radius: 35px; padding: 6px 6px 6px 18px; 
            display: flex; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.03);
        }
        #pesan { flex: 1; border: none; outline: none; background: transparent; font-size: 16px; padding: 10px 0; font-family: inherit; }
        
        .btn-action { background: none; border: none; font-size: 22px; cursor: pointer; padding: 0 10px; flex-shrink: 0; }
        
        .btn-send { 
            width: 46px; height: 46px; border-radius: 50%; border: none; 
            background: var(--text); color: #FFF; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; /* Mencegah tombol jadi penyok */
            transition: 0.2s;
        }
        .btn-send:active { transform: scale(0.9); }

        .loader { display: none; padding: 0 25px 15px; gap: 4px; }
        .dot { width: 5px; height: 5px; background: var(--primary); border-radius: 50%; animation: blink 1.4s infinite; }
    </style>
</head>
<body onload="initAuth()">

    <div id="auth-screen">
        <div class="auth-card">
            <div style="font-size: 50px; margin-bottom: 15px;">ðŸŒ¸</div>
            <h2 id="at">Flora AI</h2>
            <p style="color:var(--sub); font-size:13px; margin-bottom:25px;">Satu asisten untuk segalanya.</p>
            <input type="text" id="au" class="input-auth" placeholder="Username">
            <input type="password" id="ap" class="input-auth" placeholder="Password">
            <button class="btn-auth" onclick="auth()">Lanjutkan</button>
            <p id="tog" style="font-size:12px; margin-top:20px; cursor:pointer;" onclick="toggle()">Belum punya akun? <b>Daftar</b></p>
        </div>
    </div>

    <div id="main-app">
        <div class="header">
            <div class="aura-header"></div>
            <div style="display:flex; align-items:center; justify-content:space-between; position:relative;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div style="width:36px; height:36px; background:#FFF; border-radius:10px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.05);">ðŸŒ¸</div>
                    <div>
                        <div style="font-weight:800; font-size:15px;">Flora AI</div>
                        <div style="font-size:9px; color:#34C759; font-weight:700;">ACTIVE</div>
                    </div>
                </div>
                <button onclick="logout()" style="background:none; border:none; color:red; font-size:10px; font-weight:800; cursor:pointer;">KELUAR</button>
            </div>
        </div>

        <div id="chat-box"></div>

        <div id="typing" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

        <div id="draft-area">
            <div class="prompt-card">
                <div style="display:flex; align-items:center; gap:12px;">
                    <img id="p-img" class="img-preview">
                    <span style="font-size:11px; font-weight:700; color:var(--sub);">SIAP DIKIRIM</span>
                </div>
                <button onclick="clearImg()" style="border:none; background:none; color:red; font-weight:800; cursor:pointer; font-size:11px;">HAPUS</button>
            </div>
        </div>

        <div class="input-wrapper">
            <div class="glass-container">
                <button class="btn-action" onclick="document.getElementById('fin').click()">ðŸ“·</button>
                <input type="file" id="fin" hidden onchange="prev()">
                <input type="text" id="pesan" placeholder="Tanya Flora..." onkeypress="if(event.key==='Enter') kirim()">
                <button class="btn-send" onclick="kirim()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let isReg = false; let curImg = null; let hist = [];
        function initAuth() { 
            const s = localStorage.getItem("f_session"); 
            if(s) show(s); 
        }
        function toggle() { 
            isReg = !isReg; 
            document.getElementById("at").innerText = isReg ? "Buat Akun" : "Flora AI"; 
            document.getElementById("tog").innerHTML = isReg ? "Sudah punya akun? <b>Masuk</b>" : "Belum punya akun? <b>Daftar</b>";
        }
        function auth() {
            const u = document.getElementById("au").value; const p = document.getElementById("ap").value;
            if(!u || !p) return;
            if(isReg) { localStorage.setItem(`u_${u}`, p); alert("Berhasil! Silakan Login."); toggle(); }
            else { if(localStorage.getItem(`u_${u}`) === p) show(u); else alert("Salah!"); }
        }
        function show(n) {
            localStorage.setItem("f_session", n);
            document.getElementById("auth-screen").style.display = "none";
            document.getElementById("main-app").style.display = "flex";
            const saved = localStorage.getItem(`h_${n}`);
            if(saved) { hist = JSON.parse(saved); hist.forEach(m => add(m.content, m.role === 'user' ? 'user' : 'bot', true)); }
        }
        function logout() { localStorage.removeItem("f_session"); location.reload(); }

        function prev() {
            const f = document.getElementById("fin").files[0];
            const r = new FileReader();
            r.onload = (e) => { curImg = e.target.result; document.getElementById("p-img").src = curImg; document.getElementById("draft-area").style.display = "block"; };
            r.readAsDataURL(f);
        }
        function clearImg() { curImg = null; document.getElementById("draft-area").style.display = "none"; }

        async function kirim() {
            const t = document.getElementById("pesan").value; if(!t && !curImg) return;
            add(t, 'user'); document.getElementById("pesan").value = ""; clearImg();
            document.getElementById("typing").style.display = "flex";
            hist.push({ role: "user", content: t });
            try {
                const res = await fetch('/api', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ history: hist }) });
                const d = await res.json();
                add(d.reply, 'bot');
                hist.push({ role: "assistant", content: d.reply });
                localStorage.setItem(`h_${localStorage.getItem("f_session")}`, JSON.stringify(hist));
            } catch (e) { add("Gagal terhubung.", 'bot'); }
            document.getElementById("typing").style.display = "none";
        }

        function add(h, type, load = false) {
            const d = document.createElement('div');
            d.className = `msg ${type}`;
            d.innerHTML = type === 'bot' ? `<span class="bot-label">FLORA AI</span><div class="bot-content">${h}</div>` : h;
            document.getElementById("chat-box").appendChild(d);
            if(!load) document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
        }
    </script>
</body>
</html>
